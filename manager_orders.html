<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление заказами - Volt Logistics</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: 'TT Runs Trial', Arial, sans-serif;
            margin: 0;
            padding: 0;
            padding-bottom: 150px; /* Increased bottom padding to 150px for better separation */
            background: #141414;
            color: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35 0%, #E74C3C 100%);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-select option {
            background: #333;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #00DBFF;
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .orders-table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        .table-header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 150px 100px 80px 100px 200px;
            gap: 15px;
            font-weight: bold;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-row {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 150px 100px 80px 100px 200px;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s ease;
        }

        .order-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .order-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }

        .order-id {
            font-weight: bold;
            color: #00DBFF;
            cursor: pointer;
        }

        .order-id:hover {
            text-decoration: underline;
        }

        .order-user {
            font-size: 14px;
            color: #ccc;
        }

        .order-items {
            font-size: 12px;
            color: #888;
        }

        .items-count,
        .photos-count {
            font-weight: bold;
            text-align: center;
            padding: 5px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            min-width: 60px;
        }

        .items-count {
            color: #00DBFF;
        }

        .photos-count {
            color: #FF6B35;
        }

        .status-select {
            background: var(--status-color);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
        }

        .status-select:hover {
            opacity: 0.8;
        }

        .date-cell {
            font-size: 12px;
            color: #ccc;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: #00DBFF;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            margin-right: 8px;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 219, 255, 0.2);
        }

        .action-btn:hover {
            background: #00B8E6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 219, 255, 0.3);
        }

        .action-btn.danger {
            background: #E74C3C;
        }

        .action-btn.danger:hover {
            background: #C0392B;
        }

        /* Общие стили для всех кнопок */
        .simple-button,
        .save-btn,
        .close-btn,
        .delete-photo-btn,
        .delete-report-btn {
            background: #00DBFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 219, 255, 0.2);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .simple-button:hover,
        .save-btn:hover,
        .close-btn:hover {
            background: #00B8E6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 219, 255, 0.3);
        }

        /* Кнопки удаления */
        .delete-photo-btn,
        .delete-report-btn {
            background: #E74C3C;
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        .delete-photo-btn:hover,
        .delete-report-btn:hover {
            background: #C0392B;
            transform: translateY(-1px);
        }

        /* Кнопка сохранения */
        .save-btn {
            background: #34C759;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: bold;
        }

        .save-btn:hover {
            background: #2ECC71;
        }

        /* Кнопка закрытия модального окна */
        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: none;
            box-shadow: none;
        }

        /* Стили кнопки "Назад" */
        .stylish-back-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 219, 255, 0.9);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 219, 255, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .stylish-back-button:hover {
            background: rgba(0, 185, 230, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 219, 255, 0.4);
        }

        .stylish-back-button:active {
            transform: translateY(0);
        }

        .stylish-back-button.show {
            opacity: 1;
            visibility: visible;
        }

        /* Фотоотчеты */
        .photo-preview {
            transition: all 0.3s ease;
        }

        .photo-preview:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        /* Модальные окна */
        .photo-modal-content {
            background: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            text-align: center;
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
        }

        /* Анимации для кнопок */
        .simple-button:active,
        .save-btn:active,
        .delete-photo-btn:active,
        .delete-report-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 219, 255, 0.2);
        }

        /* Специальные стили для кнопок действий */
        .action-btn {
            white-space: nowrap;
            min-width: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            background: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #00DBFF;
        }

        .save-btn {
            background: #34C759;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .save-btn:hover {
            background: #2ECC71;
        }

        /* Комплексные стили для всех кнопок */
        .simple-button,
        .save-btn,
        .delete-photo-btn,
        .delete-report-btn,
        .action-btn,
        .back-btn,
        .stylish-back-button {
            background: #00DBFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 219, 255, 0.2);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: 'TT Runs', Arial, sans-serif;
            min-height: 44px;
            position: relative;
            overflow: hidden;
        }

        /* Специальные цвета для разных типов кнопок */
        .save-btn {
            background: #28a745 !important;
        }

        .delete-photo-btn,
        .delete-report-btn {
            background: #dc3545 !important;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1) !important;
        }

        /* Hover эффекты для всех кнопок */
        .simple-button:hover,
        .action-btn:hover,
        .stylish-back-button:hover {
            background: #00B8E6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 219, 255, 0.4);
        }

        .save-btn:hover {
            background: #218838 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .delete-photo-btn:hover,
        .delete-report-btn:hover {
            background: #c82333 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }

        /* Active состояние для всех кнопок */
        .simple-button:active,
        .save-btn:active,
        .delete-photo-btn:active,
        .delete-report-btn:active,
        .action-btn:active,
        .back-btn:active,
        .stylish-back-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Анимация загрузки для кнопок */
        .simple-button:before,
        .action-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .simple-button:hover:before,
        .action-btn:hover:before {
            left: 100%;
        }

        /* Стили для модальных кнопок */
        .modal-button,
        .close-btn {
            background: #00DBFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
            font-family: 'TT Runs', Arial, sans-serif;
        }

        .close-btn {
            background: #dc3545;
            padding: 8px 12px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            line-height: 1;
        }

        .close-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #E74C3C;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Стили для фото в модальном окне */
        .photo-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            border: 2px solid #00DBFF;
            position: relative;
        }

        .photo-preview:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .photos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .photo-item {
            position: relative;
            display: inline-block;
        }

        .photo-actions {
            position: absolute;
            top: -5px;
            right: -5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .photo-item:hover .photo-actions {
            opacity: 1;
        }

        .photo-action-btn {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .photo-action-btn:hover {
            background: #00DBFF;
            transform: scale(1.1);
        }

        .photo-action-btn.download {
            background: rgba(52, 199, 89, 0.9);
        }

        .photo-action-btn.download:hover {
            background: #34C759;
        }

        .photo-action-btn.enhance {
            background: rgba(255, 107, 53, 0.9);
        }

        .photo-action-btn.enhance:hover {
            background: #FF6B35;
        }

        .photo-modal-content {
            background: #2a2a2a;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            text-align: center;
        }

        .photo-modal-content img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .photo-modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .enhance-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .enhance-slider {
            width: 100%;
            margin: 10px 0;
            -webkit-appearance: none;
            height: 5px;
            border-radius: 5px;
            background: #555;
            outline: none;
        }

        .enhance-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00DBFF;
            cursor: pointer;
        }

        .enhance-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00DBFF;
            cursor: pointer;
            border: none;
        }

        .enhance-preview {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .enhance-preview img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #555;
        }

        .enhance-preview .original {
            border-color: #888;
        }

        .enhance-preview .enhanced {
            border-color: #00DBFF;
        }

        .enhance-label {
            text-align: center;
            margin-bottom: 10px;
            color: #ccc;
            font-size: 14px;
        }

        @media (max-width: 768px) {

            .table-header,
            .order-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .actions {
                flex-direction: column;
                gap: 8px;
            }

            .action-btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
        }

        /* SVG Back Button Styles */
        .svg-back-button {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
            opacity: 1;
            visibility: visible;
        }

        .svg-back-button.show {
            opacity: 1;
            visibility: visible;
        }

        .svg-back-button:hover {
            transform: translateX(-50%) translateY(-4px);
            filter: brightness(1.1);
        }

        .svg-back-button:active {
            transform: translateX(-50%) translateY(-2px);
        }

        .back-button-svg {
            width: 180px;
            height: auto;
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.4));
            transition: all 0.3s ease;
        }

        .svg-back-button:hover .back-button-svg {
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.5)) brightness(1.1);
        }
    </style>
    <script src="js/common.js"></script>
    <script src="js/manager_orders.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>

<body>
    <div class="page-container">
        <div class="page-header">
            <h1 class="page-title">👨‍💼 Управление заказами</h1>
            <p class="page-subtitle">Панель менеджера для управления всеми заказами</p>
        </div>

        <div class="content-section">
            <div
                style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center; justify-content: space-between;">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <select class="simple-input" id="statusFilter" onchange="filterOrders()"
                        style="width: auto; min-width: 150px;">
                        <option value="">Все статусы</option>
                    </select>
                    <select class="simple-input" id="userFilter" onchange="filterOrders()"
                        style="width: auto; min-width: 150px;">
                        <option value="">Все пользователи</option>
                    </select>
                </div>
                <button class="simple-button" onclick="loadAllOrders()">🔄 Обновить</button>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <div class="loading">Загрузка статистики...</div>
        </div>

        <div class="orders-table">
            <div class="table-header">
                <div>Заказ / Пользователь</div>
                <div>Статус</div>
                <div>Создан</div>
                <div>Товаров</div>
                <div>Обновлен</div>
                <div>Действия</div>
            </div>
            <div id="ordersContainer">
                <div class="loading">Загрузка заказов...</div>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования заказа -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Редактирование заказа</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div id="editForm">
                <!-- Форма будет заполнена динамически -->
            </div>
        </div>
    </div>

    <script>
        // Переменные объявлены в manager_orders.js
        // let allOrders = [];
        // let filteredOrders = [];
        // let orderStatuses = {};
        // let currentEditOrder = null;

        // Загружаем статусы заказов
        async function loadOrderStatuses() {
            try {
                const response = await fetch('http://localhost:5000/api/orders/statuses');
                const data = await response.json();

                if (data.status === 'success') {
                    data.statuses.forEach(status => {
                        orderStatuses[status.id] = status;
                    });

                    // Заполняем фильтр статусов
                    const statusFilter = document.getElementById('statusFilter');
                    data.statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.id;
                        option.textContent = status.name;
                        statusFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки статусов:', error);
            }
        }

        // Загружаем все заказы
        async function loadAllOrders() {
            console.log('Начало загрузки всех заказов');
            const container = document.getElementById('ordersContainer');
            container.innerHTML = '<div class="loading">Загрузка заказов...</div>';

            try {
                console.log('Отправка запроса к API: http://localhost:5000/api/orders/all');
                const response = await fetch('http://localhost:5000/api/orders/all');
                console.log('Получен ответ от API, статус:', response.status);
                const data = await response.json();
                console.log('Полученные данные:', data);

                if (data.status === 'success') {
                    console.log('Полученные заказы:', data.orders);
                    // Добавляем ID заказа из имени файла
                    allOrders = data.orders.map(order => {
                        console.log('Обработка заказа:', order);
                        // Убедимся, что у заказа есть все необходимые поля
                        const processedOrder = {
                            ...order,
                            id: order.id || 'unknown',
                            status: order.status || 'pending_check',
                            created_at: order.created_at || new Date().toISOString(),
                            status_updated_at: order.status_updated_at || new Date().toISOString()
                        };
                        console.log('Обработанный заказ:', processedOrder);
                        return processedOrder;
                    });
                    filteredOrders = [...allOrders];
                    console.log('Все заказы:', allOrders);
                    displayOrders();
                    updateStats();
                    updateUserFilter();

                    // Показываем уведомление для менеджера
                    if (allOrders.length > 0) {
                        const firstOrder = allOrders[0];
                        if (firstOrder.items && firstOrder.items.some(item => item.photos && item.photos.length > 0)) {
                            // Проверяем, есть ли фотографии в заказах
                            const ordersWithPhotos = allOrders.filter(order =>
                                order.items && order.items.some(item => item.photos && item.photos.length > 0)
                            );

                            if (ordersWithPhotos.length > 0) {
                                console.log('Найдены заказы с фотографиями:', ordersWithPhotos.length);
                            }
                        }
                    }
                } else {
                    console.error('Ошибка загрузки заказов:', data.message);
                    showError(data.message || 'Ошибка загрузки заказов');
                }
            } catch (error) {
                console.error('Ошибка загрузки заказов:', error);
                showError('Ошибка соединения с сервером. Убедитесь, что API сервер запущен на порту 5000.');
            }
        }

        // Отображаем заказы
        function displayOrders() {
            const container = document.getElementById('ordersContainer');

            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="loading">Заказы не найдены</div>';
                return;
            }

            console.log('Отображаем заказы:', filteredOrders);
            const ordersHTML = filteredOrders.map(order => {
                console.log('Создаем строку для заказа:', order);
                return createOrderRow(order);
            }).join('');
            container.innerHTML = ordersHTML;
        }

        // Создаем строку заказа
        function createOrderRow(order) {
            const status = orderStatuses[order.status] || { name: order.status, color: '#888' };
            const createdDate = new Date(order.created_at).toLocaleDateString('ru-RU');
            const updatedDate = new Date(order.status_updated_at).toLocaleDateString('ru-RU');

            // Получаем количество товаров и фотографий
            const itemsCount = order.total_items || (order.items && order.items.length) || 0;
            const photosCount = order.total_photos || (order.items ? order.items.reduce((sum, item) => sum + (item.photos ? item.photos.length : 0), 0) : 0);

            return `
                <div class="order-row">
                    <div class="order-info">
                        <div class="order-id" onclick="showOrderDetails('${order.id}')">
                            ${order.order_number ? `#${order.order_number}` : `ID: ${order.id}`}
                        </div>
                        ${!order.order_number ? `<div class="order-full-id" style="font-size: 10px; color: #666;">
                            ID: ${order.id}
                        </div>` : ''}
                        <div class="order-user">
                            👤 ${order.full_name || order.telegram_username || 'Без имени'}
                        </div>
                        <div class="order-items" style="display: flex; flex-direction: column; gap: 5px;">
                            <div>📦 ${itemsCount} товаров</div>
                            <div>📷 ${photosCount} фото</div>
                        </div>
                    </div>
                    <div class="status-display" style="background: ${status.color}; color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-align: center; min-width: 120px;">
                        ${status.name}
                    </div>
                    <div class="date-cell">${createdDate}</div>
                    <div class="items-count">📦 ${itemsCount}</div>
                    <div class="photos-count">📷 ${photosCount}</div>
                    <div class="date-cell">${updatedDate}</div>
                    <div class="actions">
                        <button class="action-btn" style="padding: 10px 18px; font-size: 14px; margin-right: 8px;" onclick="editOrder('${order.id}')">✏️ Редактировать</button>
                        <button class="action-btn" style="padding: 10px 18px; font-size: 14px;" onclick="showOrderDetails('${order.id}')">👁️ Просмотр</button>
                    </div>
                </div>
            `;
        }

        // Status editing is now handled through the edit modal
        // Function removed since status dropdowns are no longer used

        // Редактирование заказа
        function editOrder(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            currentEditOrder = order;
            const country = order.country === 'china' ? 'Китае' : order.country === 'japan' ? 'Японии' : 'стране выкупа';

            const form = document.getElementById('editForm');
            form.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Номер заказа</label>
                    <input type="text" class="form-input" id="editOrderNumber" 
                           value="${order.order_number || ''}" 
                           placeholder="Введите короткий номер заказа (например: 001, 002)">
                    <small style="color: #888; font-size: 12px;">ID системы: ${order.id}</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Статус заказа</label>
                    <select class="form-select" id="editStatus" onchange="onStatusChange()">
                        ${Object.values(orderStatuses).map(s =>
                `<option value="${s.id}" ${s.id === order.status ? 'selected' : ''}>${s.name}</option>`
            ).join('')}
                    </select>
                    <small style="color: #888; font-size: 12px; margin-top: 5px; display: block;" id="statusDescription">
                        ${(orderStatuses[order.status] && orderStatuses[order.status].description) || ''}
                    </small>
                </div>
                
                <!-- Поле для номера отслеживания (показывается только для СДЭК) -->
                <div class="form-group" id="trackingGroup" style="display: ${order.status === 'cdek_shipping' ? 'block' : 'none'}">
                    <label class="form-label">Номер накладной СДЭК</label>
                    <input type="text" class="form-input" id="editTracking" 
                           value="${order.tracking_number || ''}" 
                           placeholder="Введите номер накладной СДЭК">
                </div>
                
                <!-- Поле для фотоотчета (показывается только для статуса 'На складе') -->
                <div class="form-group" id="photoReportGroup" style="display: ${order.status === 'at_warehouse_photo' ? 'block' : 'none'}">
                    <label class="form-label">Фотоотчет со склада в ${country}</label>
                    
                    <!-- Существующие фотоотчеты -->
                    ${order.photo_reports && order.photo_reports.length > 0 ? `
                        <div class="existing-photo-reports" style="margin-bottom: 15px;">
                            <h4 style="color: #2ECC71; margin: 0 0 10px 0;">📷 Существующие фотоотчеты</h4>
                            <div class="photo-reports-list">
                                ${order.photo_reports.map((report, reportIndex) => `
                                    <div class="photo-report-item" style="background: rgba(46,204,113,0.1); border: 1px solid rgba(46,204,113,0.3); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                                            ${new Date(report.timestamp || order.status_updated_at).toLocaleString('ru-RU')} - ${report.by || 'manager'}
                                        </div>
                                        <div class="photo-thumbnails" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                            ${report.photos ? report.photos.map((photo, photoIndex) => `
                                                <div class="photo-thumbnail" style="position: relative; display: inline-block;">
                                                    <img src="${photo}" alt="Фотоотчет ${reportIndex + 1}-${photoIndex + 1}" 
                                                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid #2ECC71; cursor: pointer;"
                                                         onclick="openManagerPhotoModal('${photo}')">
                                                    <button class="delete-photo-btn" onclick="deleteExistingPhoto(${reportIndex}, ${photoIndex})" 
                                                            style="position: absolute; top: -5px; right: -5px; background: #E74C3C; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                                        ×
                                                    </button>
                                                    <div style="position: absolute; bottom: 2px; right: 2px; background: rgba(46,204,113,0.8); color: white; border-radius: 3px; padding: 2px 4px; font-size: 10px;">
                                                        ${photoIndex + 1}
                                                    </div>
                                                </div>
                                            `).join('') : ''}
                                        </div>
                                        <button class="delete-report-btn" onclick="deletePhotoReport(${reportIndex})" 
                                                style="background: #E74C3C; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-top: 8px; cursor: pointer;">
                                            🗑️ Удалить весь отчет
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Добавить новые фото -->
                    <input type="file" class="form-input" id="photoReportInput" multiple accept="image/*" onchange="handlePhotoReportUpload()">
                    <small style="color: #888; font-size: 12px;">Выберите фотографии для отчета</small>
                    <div id="photoReportPreview" style="margin-top: 10px;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Комментарий для пользователя</label>
                    <textarea class="form-textarea" id="managerComment" 
                              placeholder="Напишите комментарий для пользователя о текущем статусе заказа"></textarea>
                    <small style="color: #888; font-size: 12px;">Этот комментарий будет виден пользователю в его заказе</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Внутренние примечания</label>
                    <textarea class="form-textarea" id="editNotes" 
                              placeholder="Внутренние примечания для менеджеров">${order.notes || ''}</textarea>
                    <small style="color: #888; font-size: 12px;">Эти примечания видны только менеджерам</small>
                </div>
                
                <!-- История комментариев -->
                ${order.manager_comments && order.manager_comments.length > 0 ? `
                <div class="form-group">
                    <label class="form-label">История комментариев</label>
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        ${order.manager_comments.map(comment => `
                            <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">
                                    ${new Date(comment.timestamp).toLocaleString('ru-RU')} - ${comment.status} (${comment.by})
                                </div>
                                <div>${comment.comment}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <button class="save-btn" onclick="saveOrderChanges()">💾 Сохранить изменения</button>
            `;

            document.getElementById('editModal').style.display = 'block';
        }

        // Обработка смены статуса
        function onStatusChange() {
            const statusSelect = document.getElementById('editStatus');
            const selectedStatus = statusSelect.value;
            const statusDescription = document.getElementById('statusDescription');
            const trackingGroup = document.getElementById('trackingGroup');
            const photoReportGroup = document.getElementById('photoReportGroup');

            // Обновляем описание статуса
            const status = orderStatuses[selectedStatus];
            if (status && statusDescription) {
                statusDescription.textContent = status.description || '';
            }

            // Показываем/скрываем поле номера отслеживания
            if (trackingGroup) {
                trackingGroup.style.display = selectedStatus === 'cdek_shipping' ? 'block' : 'none';
            }

            // Показываем/скрываем поле фотоотчета
            if (photoReportGroup) {
                photoReportGroup.style.display = selectedStatus === 'at_warehouse_photo' ? 'block' : 'none';
            }
        }

        // Функция открытия фото в модальном окне (для менеджера)
        function openManagerPhotoModal(photoUrl) {
            const modalHTML = `
                <div id="managerPhotoModal" class="modal" style="display: flex; background: rgba(0,0,0,0.9);">
                    <div class="photo-modal-content">
                        <div class="modal-header" style="background: transparent; border: none;">
                            <button class="close-btn" onclick="closeManagerPhotoModal()" style="color: white; font-size: 30px;">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 0;">
                            <img src="${photoUrl}" alt="Фотоотчет" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                        </div>
                        <div class="modal-footer" style="text-align: center; padding-top: 15px;">
                            <button class="save-btn" onclick="closeManagerPhotoModal()">Закрыть</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Функция закрытия модального окна фото
        function closeManagerPhotoModal() {
            const modal = document.getElementById('managerPhotoModal');
            if (modal) {
                modal.remove();
            }
        }

        // Безопасная функция для закрытия и уничтожения модальных окон
        function safeCloseModal() {
            console.log('🛡️ Запуск безопасного закрытия модального окна...');

            try {
                // Метод 1: Простое скрытие через CSS
                const modalsToHide = document.querySelectorAll('.modal, #editModal');
                modalsToHide.forEach((modal, index) => {
                    try {
                        if (modal) {
                            modal.style.display = 'none';
                            modal.style.visibility = 'hidden';
                            console.log(`Скрыто модальное окно ${index + 1}`);
                        }
                    } catch (hideError) {
                        console.log(`Ошибка при скрытии модального окна ${index + 1}:`, hideError.message);
                    }
                });

                // Метод 2: Отложенное удаление
                setTimeout(() => {
                    try {
                        const modalsToRemove = document.querySelectorAll('.modal, #editModal');
                        modalsToRemove.forEach((modal, index) => {
                            try {
                                if (modal && modal.parentNode) {
                                    modal.parentNode.removeChild(modal);
                                    console.log(`Удалено модальное окно ${index + 1} через parentNode`);
                                }
                            } catch (removeError) {
                                console.log(`Не удалось удалить модальное окно ${index + 1}:`, removeError.message);
                            }
                        });
                    } catch (cleanupError) {
                        console.log('Ошибка при отложенной очистке:', cleanupError.message);
                    }
                }, 100);

                console.log('✅ Безопасное закрытие модального окна завершено');
                return true;

            } catch (globalError) {
                console.error('🚨 Критическая ошибка при закрытии модального окна:', globalError.message);
                return false;
            }
        }

        // Удаление отдельного фото из существующего отчета - УЛЬТРА-АГРЕССИВНЫЙ МЕТОД
        async function deleteExistingPhoto(reportIndex, photoIndex) {
            console.log(`🔥 УЛЬТРА-АГРЕССИВНОЕ УДАЛЕНИЕ: Фото ${photoIndex} из отчета ${reportIndex}`);

            if (confirm('Удалить это фото из отчета?')) {
                try {
                    // ШАГ 1: ПРИНУДИТЕЛЬНАЯ ЗАГРУЗКА ДАННЫХ
                    console.log('📥 ШАГ 1: Принудительная загрузка свежих данных...');

                    const freshResponse = await fetch(`http://localhost:5000/api/orders/all?t=${Date.now()}&force=ultra&nocache=${Math.random()}`);
                    const freshData = await freshResponse.json();

                    if (freshData.status !== 'success') {
                        throw new Error('Не удалось загрузить свежие данные с сервера');
                    }

                    const serverOrder = freshData.orders.find(o => o.id === currentEditOrder.id);
                    if (!serverOrder) {
                        throw new Error('Заказ не найден в свежих данных сервера');
                    }

                    console.log('✅ ШАГ 1 ЗАВЕРШЕН: Свежие данные получены:', serverOrder.photo_reports);

                    // ШАГ 2: СОЗДАНИЕ АБСОЛЮТНО НОВОЙ КОПИИ ДАННЫХ
                    console.log('🔄 ШАГ 2: Создание новой копии данных...');

                    let newPhotoReports = [];
                    if (serverOrder.photo_reports && Array.isArray(serverOrder.photo_reports)) {
                        // Глубокое копирование каждого отчета
                        newPhotoReports = serverOrder.photo_reports.map((report, idx) => {
                            if (idx === reportIndex) {
                                // Для удаляемого отчета создаем новый массив фото БЕЗ удаляемого
                                const newPhotos = [];
                                report.photos.forEach((photo, pIdx) => {
                                    if (pIdx !== photoIndex) {
                                        newPhotos.push(JSON.parse(JSON.stringify(photo)));
                                    }
                                });
                                return {
                                    ...JSON.parse(JSON.stringify(report)),
                                    photos: newPhotos
                                };
                            } else {
                                return JSON.parse(JSON.stringify(report));
                            }
                        });

                        // Удаляем пустые отчеты
                        newPhotoReports = newPhotoReports.filter(report =>
                            report.photos && report.photos.length > 0
                        );
                    }

                    console.log(`✅ ШАГ 2 ЗАВЕРШЕН: Отчетов было ${(serverOrder.photo_reports || []).length}, стало ${newPhotoReports.length}`);

                    // ШАГ 3: УЛЬТРА-АГРЕССИВНОЕ ОБНОВЛЕНИЕ СЕРВЕРА
                    console.log('💥 ШАГ 3: Ультра-агрессивное обновление сервера...');

                    const ultraUpdateResponse = await fetch(`http://localhost:5000/api/orders/${currentEditOrder.id}/status?ultra_force=true&t=${Date.now()}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({
                            status: serverOrder.status,
                            order_number: serverOrder.order_number || '',
                            tracking_number: serverOrder.tracking_number || '',
                            notes: serverOrder.notes || '',
                            updated_by: 'manager_ultra_aggressive',
                            photo_reports: newPhotoReports,
                            // УЛЬТРА-ПРИНУДИТЕЛЬНЫЕ ПАРАМЕТРЫ
                            ultra_force: true,
                            force_update: true,
                            delete_operation: 'single_photo',
                            delete_details: {
                                report_index: reportIndex,
                                photo_index: photoIndex,
                                timestamp: Date.now(),
                                operation_id: Math.random().toString(36)
                            },
                            timestamp: Date.now()
                        })
                    });

                    const ultraUpdateData = await ultraUpdateResponse.json();

                    if (ultraUpdateData.status !== 'success') {
                        throw new Error(`Ультра-агрессивное обновление провалено: ${ultraUpdateData.message}`);
                    }

                    console.log('✅ ШАГ 3 ЗАВЕРШЕН: Сервер обновлен успешно');

                    // ШАГ 4: СЕРИЯ ПРИНУДИТЕЛЬНЫХ ПЕРЕЗАГРУЗОК
                    console.log('🔄 ШАГ 4: Серия принудительных перезагрузок...');

                    // Обнуляем все локальные данные
                    allOrders = [];
                    currentEditOrder = null;

                    // Три перезагрузки для абсолютной уверенности
                    await loadAllOrders();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await loadAllOrders();
                    await new Promise(resolve => setTimeout(resolve, 300));
                    await loadAllOrders();

                    console.log('✅ ШАГ 4 ЗАВЕРШЕН: Все данные перезагружены');

                    // ШАГ 5: БЕЗОПАСНОЕ ЗАКРЫТИЕ МОДАЛЬНОГО ОКНА
                    console.log('🧹 ШАГ 5: Безопасное закрытие модального окна...');
                    safeCloseModal();

                    const updatedOrder = allOrders.find(o => o.id === serverOrder.id);
                    if (!updatedOrder) {
                        throw new Error('Не удалось найти обновленный заказ после перезагрузки');
                    }

                    console.log('✅ ШАГ 5 ЗАВЕРШЕН: Модальное окно безопасно закрыто');

                    // ШАГ 6: ВОССОЗДАНИЕ МОДАЛЬНОГО ОКНА
                    console.log('🔥 ШАГ 6: Воссоздание модального окна...');

                    await new Promise(resolve => setTimeout(resolve, 500));
                    editOrder(updatedOrder.id);

                    console.log('✅ ШАГ 6 ЗАВЕРШЕН: Модальное окно воссоздано');

                    console.log('🎉 УЛЬТРА-АГРЕССИВНОЕ УДАЛЕНИЕ ЗАВЕРШЕНО УСПЕШНО!');
                    alert('🔥 Фото УЛЬТРА-АГРЕССИВНО УНИЧТОЖЕНО!');

                } catch (error) {
                    console.error('💥 ОШИБКА УЛЬТРА-АГРЕССИВНОГО УДАЛЕНИЯ:', error);

                    // Проверяем, была ли операция фактически успешной
                    try {
                        console.log('🔍 Проверяем, было ли удаление фактически успешным...');

                        // Перезагружаем данные для проверки
                        await loadAllOrders();

                        // Проверяем, остались ли фото в отчете
                        const checkOrder = allOrders.find(o => o.id === currentEditOrder.id);
                        if (checkOrder && checkOrder.photo_reports) {
                            const reportExists = checkOrder.photo_reports[reportIndex];
                            const photoExists = reportExists && reportExists.photos && reportExists.photos[photoIndex];

                            if (!photoExists) {
                                console.log('✅ УДАЛЕНИЕ ФАКТИЧЕСКИ УСПЕШНО! Игнорируем техническую ошибку...');

                                // Успешное удаление, просто обновляем интерфейс
                                safeCloseModal();

                                setTimeout(() => {
                                    try {
                                        editOrder(checkOrder.id);
                                        alert('✅ Фото успешно удалено!');
                                    } catch (reopenError) {
                                        console.log('Ошибка при переоткрытии модального окна:', reopenError.message);
                                        alert('✅ Фото удалено! Обновите страницу для корректного отображения.');
                                    }
                                }, 500);

                                return; // Выходим, не показываем критическую ошибку
                            }
                        }

                        // Если дошли сюда, то удаление действительно не удалось
                        console.log('❌ Удаление действительно не удалось');
                        alert('❌ Ошибка при удалении фото: ' + error.message);

                    } catch (checkError) {
                        console.log('Ошибка при проверке результата удаления:', checkError.message);
                        alert('⚠️ Ошибка при удалении фото. Обновите страницу для проверки результата.');
                    }
                }
            }
        }

        // Удаление всего фотоотчета - УЛЬТРА-АГРЕССИВНЫЙ МЕТОД
        async function deletePhotoReport(reportIndex) {
            console.log(`🔥 УЛЬТРА-АГРЕССИВНОЕ УДАЛЕНИЕ ОТЧЕТА: Отчет ${reportIndex}`);

            if (confirm('Удалить весь фотоотчет?')) {
                try {
                    // Принудительная загрузка свежих данных
                    const ultraResponse = await fetch(`http://localhost:5000/api/orders/all?t=${Date.now()}&ultra=${Math.random()}`);
                    const ultraData = await ultraResponse.json();

                    if (ultraData.status !== 'success') {
                        throw new Error('Провал загрузки данных');
                    }

                    const serverOrder = ultraData.orders.find(o => o.id === currentEditOrder.id);
                    if (!serverOrder) {
                        throw new Error('Заказ не найден');
                    }

                    // Создаем новый массив отчетов БЕЗ удаляемого
                    let newReports = [];
                    if (serverOrder.photo_reports && Array.isArray(serverOrder.photo_reports)) {
                        serverOrder.photo_reports.forEach((report, idx) => {
                            if (idx !== reportIndex) {
                                newReports.push(JSON.parse(JSON.stringify(report)));
                            }
                        });
                    }

                    console.log(`Отчетов было ${(serverOrder.photo_reports || []).length}, стало ${newReports.length}`);

                    // Ультра-агрессивное обновление сервера
                    const updateResponse = await fetch(`http://localhost:5000/api/orders/${currentEditOrder.id}/status?ultra_force=true&t=${Date.now()}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        },
                        body: JSON.stringify({
                            status: serverOrder.status,
                            order_number: serverOrder.order_number || '',
                            tracking_number: serverOrder.tracking_number || '',
                            notes: serverOrder.notes || '',
                            updated_by: 'manager_ultra_force',
                            photo_reports: newReports,
                            ultra_force: true,
                            force_update: true,
                            delete_operation: 'entire_report',
                            delete_details: {
                                report_index: reportIndex,
                                timestamp: Date.now(),
                                operation_id: Math.random().toString(36)
                            },
                            timestamp: Date.now()
                        })
                    });

                    const updateData = await updateResponse.json();
                    if (updateData.status !== 'success') {
                        throw new Error(`Обновление провалено: ${updateData.message}`);
                    }

                    // Множественные перезагрузки для гарантированного обновления
                    allOrders = [];
                    currentEditOrder = null;

                    // Четыре перезагрузки для абсолютной уверенности
                    for (let i = 0; i < 4; i++) {
                        await loadAllOrders();
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }

                    // Безопасное закрытие модального окна
                    console.log('🧹 Безопасное закрытие модального окна...');
                    safeCloseModal();

                    // Находим обновленный заказ
                    const updatedOrder = allOrders.find(o => o.id === serverOrder.id);
                    if (!updatedOrder) {
                        throw new Error('Обновленный заказ не найден');
                    }

                    // Воссоздание модального окна
                    await new Promise(resolve => setTimeout(resolve, 800));
                    editOrder(updatedOrder.id);

                    console.log('🎉 УЛЬТРА-АГРЕССИВНОЕ УДАЛЕНИЕ ОТЧЕТА ЗАВЕРШЕНО!');
                    alert('🔥 Фотоотчет УЛЬТРА-АГРЕССИВНО УНИЧТОЖЕН!');

                } catch (error) {
                    console.error('💥 ОШИБКА УЛЬТРА-АГРЕССИВНОГО УДАЛЕНИЯ ОТЧЕТА:', error);

                    // Проверяем, было ли удаление отчета фактически успешным
                    try {
                        console.log('🔍 Проверяем результат удаления отчета...');

                        // Перезагружаем данные
                        await loadAllOrders();

                        // Проверяем, удалился ли отчет
                        const checkOrder = allOrders.find(o => o.id === currentEditOrder.id);
                        if (checkOrder) {
                            const reportStillExists = checkOrder.photo_reports && checkOrder.photo_reports[reportIndex];

                            if (!reportStillExists) {
                                console.log('✅ ОТЧЕТ ФАКТИЧЕСКИ УДАЛЕН! Игнорируем техническую ошибку...');

                                // Успешное удаление, просто обновляем интерфейс
                                safeCloseModal();

                                setTimeout(() => {
                                    try {
                                        editOrder(checkOrder.id);
                                        alert('✅ Фотоотчет успешно удален!');
                                    } catch (reopenError) {
                                        console.log('Ошибка при переоткрытии:', reopenError.message);
                                        alert('✅ Фотоотчет удален! Обновите страницу для корректного отображения.');
                                    }
                                }, 500);

                                return; // Выходим, не показываем критическую ошибку
                            }
                        }

                        // Если дошли сюда, то удаление действительно не удалось
                        console.log('❌ Удаление отчета действительно не удалось');
                        alert('❌ Ошибка при удалении отчета: ' + error.message);

                    } catch (checkError) {
                        console.log('Ошибка при проверке результата:', checkError.message);
                        alert('⚠️ Ошибка при удалении отчета. Обновите страницу для проверки.');
                    }
                }
            }
        }

        // Обработка загрузки фотоотчета
        let photoReportFiles = [];

        function handlePhotoReportUpload() {
            const input = document.getElementById('photoReportInput');
            const preview = document.getElementById('photoReportPreview');

            if (input.files.length === 0) {
                preview.innerHTML = '';
                photoReportFiles = [];
                return;
            }

            photoReportFiles = [];
            preview.innerHTML = '';

            Array.from(input.files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        photoReportFiles.push({
                            name: file.name,
                            data: e.target.result
                        });

                        // Добавляем превью фото
                        const imgPreview = document.createElement('div');
                        imgPreview.style.cssText = 'display: inline-block; margin: 5px; position: relative;';
                        imgPreview.innerHTML = `
                            <img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #00DBFF;">
                            <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                ${index + 1}
                            </div>
                        `;
                        preview.appendChild(imgPreview);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        async function saveOrderChanges() {
            if (!currentEditOrder) return;

            const orderNumber = document.getElementById('editOrderNumber').value;
            const newStatus = document.getElementById('editStatus').value;
            const trackingNumber = document.getElementById('editTracking')?.value || '';
            const notes = document.getElementById('editNotes').value;
            const managerComment = document.getElementById('managerComment').value;

            try {
                // Подготавливаем данные для отправки
                const updateData = {
                    status: newStatus,
                    order_number: orderNumber,
                    tracking_number: trackingNumber,
                    notes: notes,
                    manager_comment: managerComment,
                    updated_by: 'manager'
                };

                // Добавляем фотоотчет, если статус "На складе" и есть фото
                if (newStatus === 'at_warehouse_photo' && photoReportFiles.length > 0) {
                    updateData.photo_report = photoReportFiles.map(file => file.data);
                }

                const response = await fetch(`http://localhost:5000/api/orders/${currentEditOrder.id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Обновляем локальные данные заказа немедленно
                    const order = allOrders.find(o => o.id === currentEditOrder.id);
                    if (order) {
                        order.status = newStatus;
                        order.order_number = orderNumber;
                        order.tracking_number = trackingNumber;
                        order.notes = notes;
                        order.status_updated_at = new Date().toISOString();
                        order.status_updated_by = 'manager';

                        // Добавляем комментарий, если есть
                        if (managerComment) {
                            if (!order.manager_comments) order.manager_comments = [];
                            order.manager_comments.push({
                                comment: managerComment,
                                timestamp: new Date().toISOString(),
                                status: newStatus,
                                by: 'manager'
                            });
                        }

                        // Добавляем фотоотчет, если есть
                        if (photoReportFiles.length > 0) {
                            if (!order.photo_reports) order.photo_reports = [];
                            order.photo_reports.push({
                                photos: photoReportFiles.map(file => file.data),
                                timestamp: new Date().toISOString(),
                                status: newStatus,
                                by: 'manager'
                            });
                        }
                    }

                    closeEditModal();
                    displayOrders(); // Обновляем отображение немедленно
                    updateStats();

                    // Показываем успешное сообщение
                    let message = 'Изменения сохранены успешно!';
                    if (orderNumber) message += `\nПрисвоен номер: ${orderNumber}`;
                    if (managerComment) message += '\nКомментарий добавлен';
                    if (photoReportFiles.length > 0) message += `\nФотоотчет: ${photoReportFiles.length} фото`;

                    alert(message);
                } else {
                    alert('Ошибка сохранения: ' + data.message);
                }
            } catch (error) {
                console.error('Ошибка сохранения:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        // Закрытие модального окна
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditOrder = null;
            photoReportFiles = []; // Очищаем фотоотчет
        }

        // Показать детали заказа в модальном окне
        function showOrderDetails(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            console.log('Отображаем детали заказа:', order);
            if (!order) return;

            // Создаем модальное окно для просмотра заказа
            const modalHTML = `
                <div id="orderViewModal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; width: 95%;">
                        <div class="modal-header">
                            <h2>${order.order_number ? `Заказ #${order.order_number}` : `Заказ ID: ${order.id}`}</h2>
                            <button class="close-btn" onclick="closeOrderViewModal()" title="Закрыть (Esc)">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                            <!-- Информация о заказе -->
                            <div class="order-info-section" style="margin-bottom: 20px;">
                                <h3>📋 Информация о заказе</h3>
                                <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <div class="info-item">
                                        <strong>Номер заказа:</strong> ${order.order_number || 'Не присвоен'}
                                    </div>
                                    <div class="info-item">
                                        <strong>ID системы:</strong> ${order.id}
                                    </div>
                                    <div class="info-item">
                                        <strong>Пользователь:</strong> ${order.full_name || order.telegram_username || 'Не указан'}
                                    </div>
                                    <div class="info-item">
                                        <strong>Telegram ID:</strong> ${order.telegram_user_id}
                                    </div>
                                    <div class="info-item">
                                        <strong>Страна:</strong> ${order.country === 'china' ? 'Китай' : order.country === 'japan' ? 'Япония' : 'Не указана'}
                                    </div>
                                    <div class="info-item">
                                        <strong>Статус:</strong> ${(orderStatuses[order.status] && orderStatuses[order.status].name) || order.status}
                                    </div>
                                    <div class="info-item">
                                        <strong>Создан:</strong> ${new Date(order.created_at).toLocaleString('ru-RU')}
                                    </div>
                                    <div class="info-item">
                                        <strong>Обновлен:</strong> ${new Date(order.status_updated_at).toLocaleString('ru-RU')}
                                    </div>
                                    ${order.tracking_number ? `<div class="info-item">
                                        <strong>Трек-номер:</strong> ${order.tracking_number}
                                    </div>` : ''}
                                    ${order.notes ? `<div class="info-item" style="grid-column: 1 / -1;">
                                        <strong>Примечания:</strong> ${order.notes}
                                    </div>` : ''}
                                </div>
                            </div>

                            <!-- Товары -->
                            <div class="order-items-section">
                                <h3>📦 Товары (${(order.items && order.items.length) || 0})</h3>
                                ${(order.items && order.items.length) ? order.items.map((item, index) => `
                                    <div class="item-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4>Товар ${index + 1}</h4>
                                        <div class="item-details" style="margin-bottom: 10px;">
                                            ${item.link_or_id ? `<div><strong>Ссылка/ID:</strong> <a href="${item.link_or_id}" target="_blank" style="color: #00DBFF;">${item.link_or_id}</a></div>` : ''}
                                            ${item.color ? `<div><strong>Цвет:</strong> ${item.color}</div>` : ''}
                                            ${item.size ? `<div><strong>Размер:</strong> ${item.size}</div>` : ''}
                                            <div><strong>Количество:</strong> ${item.quantity || 1}</div>
                                            ${item.price ? `<div><strong>Цена:</strong> ${item.price} ¥</div>` : ''}
                                            ${item.comment ? `<div><strong>Комментарий:</strong> ${item.comment}</div>` : ''}
                                        </div>
                                        ${item.photos && item.photos.length > 0 ? `
                                            <div class="item-photos">
                                                <strong>Фото (${item.photos.length}):</strong>
                                                <div class="photos-container" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                                    ${item.photos.map((photo, photoIndex) => `
                                                        <div class="photo-item" style="position: relative; display: inline-block;">
                                                            <img src="${photo}" alt="Фото товара ${photoIndex + 1}" 
                                                                 class="photo-preview"
                                                                 style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #00DBFF; cursor: pointer;"
                                                                 onclick="showPhotoWithActions('${photo}', 'order_${order.id}_item_${itemIndex}_photo_${photoIndex + 1}.jpg', '${order.id}', ${itemIndex})">
                                                            
                                                            <div class="photo-actions">
                                                                <button class="photo-action-btn download" 
                                                                        onclick="event.stopPropagation(); downloadPhoto('${photo}', 'order_${order.id}_item_${itemIndex}_photo_${photoIndex + 1}.jpg')"
                                                                        title="Скачать фото">
                                                                    💾
                                                                </button>
                                                                <button class="photo-action-btn enhance" 
                                                                        onclick="event.stopPropagation(); showPhotoEnhancer('${photo}', 'order_${order.id}_item_${itemIndex}_photo_${photoIndex + 1}.jpg')"
                                                                        title="Улучшить качество">
                                                                    🎨
                                                                </button>
                                                            </div>
                                                            
                                                            <div style="position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                                ${photoIndex + 1}
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : '<div><em>Фото не приложены</em></div>'}
                                    </div>
                                `).join('') : '<div><em>Товары не найдены</em></div>'}
                            </div>
                            
                            <!-- Комментарии менеджера -->
                            ${order.manager_comments && order.manager_comments.length > 0 ? `
                            <div class="manager-comments-section" style="margin-top: 20px;">
                                <h3>💬 Комментарии менеджера</h3>
                                ${order.manager_comments.map(comment => `
                                    <div class="comment-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #00DBFF;">
                                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">
                                            ${new Date(comment.timestamp).toLocaleString('ru-RU')} - ${(orderStatuses[comment.status] && orderStatuses[comment.status].name) || comment.status} (от ${comment.by})
                                        </div>
                                        <div style="color: #fff;">${comment.comment}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            <!-- Фотоотчеты -->
                            ${order.photo_reports && order.photo_reports.length > 0 ? `
                            <div class="photo-reports-section" style="margin-top: 20px;">
                                <h3>📷 Фотоотчеты менеджера</h3>
                                ${order.photo_reports.map((report, reportIndex) => `
                                    <div class="report-card" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #FF6B35;">
                                        <h4>Отчет ${reportIndex + 1}</h4>
                                        <div style="font-size: 12px; color: #888; margin-bottom: 10px;">
                                            ${new Date(report.timestamp).toLocaleString('ru-RU')} - ${(orderStatuses[report.status] && orderStatuses[report.status].name) || report.status} (от ${report.by})
                                        </div>
                                        <div class="photos-container" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                            ${report.photos.map((photo, photoIndex) => `
                                                <div class="photo-item" style="position: relative; display: inline-block;">
                                                    <img src="${photo}" alt="Фотоотчет ${photoIndex + 1}" 
                                                         class="photo-preview"
                                                         style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #FF6B35; cursor: pointer;"
                                                         onclick="showPhotoWithActions('${photo}', 'order_${order.id}_report_${reportIndex}_photo_${photoIndex + 1}.jpg', '${order.id}', 'report')">
                                                    
                                                    <div class="photo-actions">
                                                        <button class="photo-action-btn download" 
                                                                onclick="event.stopPropagation(); downloadPhoto('${photo}', 'order_${order.id}_report_${reportIndex}_photo_${photoIndex + 1}.jpg')"
                                                                title="Скачать фото">
                                                            💾
                                                        </button>
                                                        <button class="photo-action-btn enhance" 
                                                                onclick="event.stopPropagation(); showPhotoEnhancer('${photo}', 'order_${order.id}_report_${reportIndex}_photo_${photoIndex + 1}.jpg')"
                                                                title="Улучшить качество">
                                                            🎨
                                                        </button>
                                                    </div>
                                                    
                                                    <div style="position: absolute; top: 5px; left: 5px; background: rgba(255,107,53,0.8); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                                                        ${photoIndex + 1}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                            
                            <!-- Информация для менеджера -->
                            <div class="manager-info" style="margin-top: 20px; padding: 15px; background: rgba(0,219,255,0.1); border-radius: 10px; border: 1px solid #00DBFF;">
                                <h4>ℹ️ Информация для менеджера</h4>
                                <p>Все данные заказа отображены выше. Менеджер может вручную перенести информацию в таблицу.</p>
                                <p><strong>Общее количество товаров:</strong> ${order.total_items || (order.items && order.items.length) || 0}</p>
                                <p><strong>Общее количество фотографий:</strong> ${order.total_photos || (order.items ? order.items.reduce((sum, item) => sum + (item.photos ? item.photos.length : 0), 0) : 0)}</p>
                            </div>
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #555;">
                            <button class="simple-button" onclick="closeOrderViewModal()" style="background: rgba(255,255,255,0.1);">
                                ← Назад к списку заказов
                            </button>
                            <button class="save-btn" onclick="closeOrderViewModal()">
                                ✓ Закрыть
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Добавляем модальное окно на страницу
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Добавляем обработчик закрытия по клику вне модального окна
            const modal = document.getElementById('orderViewModal');
            if (modal) {
                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeOrderViewModal();
                    }
                });

                // Добавляем обработчик закрытия по клавише Escape
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        closeOrderViewModal();
                    }
                });
            }
        }

        // Закрыть модальное окно просмотра заказа
        function closeOrderViewModal() {
            const modal = document.getElementById('orderViewModal');
            if (modal) {
                modal.remove();
                // Удаляем обработчик клавиши Escape
                document.removeEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        closeOrderViewModal();
                    }
                });
            }
        }

        // Открыть фото в отдельном модальном окне
        function openPhotoModal(photoUrl) {
            // Скрываем модальное окно заказа
            const orderModal = document.getElementById('orderViewModal');
            if (orderModal) {
                orderModal.style.display = 'none';
            }

            const photoModalHTML = `
                <div id="photoModal" class="modal" style="display: flex; background: rgba(0,0,0,0.9);">
                    <div class="photo-modal-content">
                        <div class="modal-header" style="background: transparent; border: none;">
                            <button class="close-btn" onclick="closePhotoModal()" style="color: white; font-size: 30px;">&times;</button>
                        </div>
                        <div class="modal-body" style="text-align: center; padding: 0;">
                            <img src="${photoUrl}" alt="Фото товара" style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                        </div>
                        <div class="modal-footer" style="text-align: right; padding-top: 15px;">
                            <button class="save-btn" onclick="closePhotoModal()">Закрыть</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', photoModalHTML);
        }

        // Закрыть модальное окно фото и вернуться к заказу
        function closePhotoModal() {
            const photoModal = document.getElementById('photoModal');
            if (photoModal) {
                photoModal.remove();
            }

            // Показываем снова модальное окно заказа
            const orderModal = document.getElementById('orderViewModal');
            if (orderModal) {
                orderModal.style.display = 'flex';
            }
        }

        // Фильтрация заказов
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const userFilter = document.getElementById('userFilter').value;

            filteredOrders = allOrders.filter(order => {
                const statusMatch = !statusFilter || order.status === statusFilter;
                const userMatch = !userFilter || order.telegram_user_id === userFilter;
                return statusMatch && userMatch;
            });

            displayOrders();
            updateStats();
        }

        // Обновление фильтра пользователей
        function updateUserFilter() {
            const userFilter = document.getElementById('userFilter');
            const users = [...new Set(allOrders.map(order => ({
                id: order.telegram_user_id,
                name: order.full_name || order.telegram_username || order.telegram_user_id
            })))];

            // Очищаем существующие опции (кроме первой)
            while (userFilter.children.length > 1) {
                userFilter.removeChild(userFilter.lastChild);
            }

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                userFilter.appendChild(option);
            });
        }

        // Обновление статистики
        function updateStats() {
            const stats = {};

            // Подсчитываем статистику по статусам
            Object.values(orderStatuses).forEach(status => {
                stats[status.id] = filteredOrders.filter(order => order.status === status.id).length;
            });

            const totalOrders = filteredOrders.length;
            const totalItems = filteredOrders.reduce((sum, order) => sum + order.total_items, 0);
            const totalPhotos = filteredOrders.reduce((sum, order) => sum + order.total_photos, 0);

            const statsContainer = document.getElementById('statsContainer');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalOrders}</div>
                    <div class="stat-label">Всего заказов</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalItems}</div>
                    <div class="stat-label">Всего товаров</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalPhotos}</div>
                    <div class="stat-label">Всего фотографий</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.pending_check || 0}</div>
                    <div class="stat-label">Ожидают проверки</div>
                </div>
            `;
        }

        // Показать ошибку
        function showError(message) {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = `
                <div class="error">
                    <strong>Ошибка:</strong> ${message}
                    <br><br>
                    <button class="action-btn" onclick="loadAllOrders()">Попробовать снова</button>
                </div>
            `;
        }

        // Закрытие модального окна по клику вне его
        window.onclick = function (event) {
            const editModal = document.getElementById('editModal');
            const orderViewModal = document.getElementById('orderViewModal');

            if (event.target === editModal) {
                closeEditModal();
            } else if (event.target === orderViewModal) {
                closeOrderViewModal();
            }
        }

        // Live-reloading для разработки
        function initLiveReload() {
            let lastModified = {};

            async function checkForChanges() {
                try {
                    const filesToWatch = ['manager_orders.html', 'style.css', 'script.js'];

                    for (const file of filesToWatch) {
                        const response = await fetch(`http://localhost:8080/${file}?check=${Date.now()}`);
                        const lastModifiedHeader = response.headers.get('last-modified');

                        if (lastModifiedHeader && lastModified[file] && lastModified[file] !== lastModifiedHeader) {
                            console.log(`🔄 Файл ${file} изменился, перезагружаем страницу...`);
                            window.location.reload();
                            return;
                        }

                        if (lastModifiedHeader) {
                            lastModified[file] = lastModifiedHeader;
                        }
                    }
                } catch (error) {
                    // Игнорируем ошибки при проверке файлов
                }
            }

            // Проверяем изменения каждые 2 секунды
            setInterval(checkForChanges, 2000);
        }

        // Инициализация при загрузке страницы
        window.addEventListener('load', async function () {
            console.log('👨‍💼 Панель управления заказами загружена');

            await loadOrderStatuses();
            await loadAllOrders();

            // Инициализируем live-reloading для разработки
            initLiveReload();
        });

        // Делаем функции глобально доступными для inline onclick handlers
        window.editOrder = editOrder;
        window.showOrderDetails = showOrderDetails;
        window.closeEditModal = closeEditModal;
        window.saveOrderChanges = saveOrderChanges;
        window.onStatusChange = onStatusChange;
        window.handlePhotoReportUpload = handlePhotoReportUpload;
        window.openManagerPhotoModal = openManagerPhotoModal;
        window.closeManagerPhotoModal = closeManagerPhotoModal;
        window.deleteExistingPhoto = deleteExistingPhoto;
        window.deletePhotoReport = deletePhotoReport;
        window.closeOrderViewModal = closeOrderViewModal;

        // Функция для скачивания фотографии
        async function downloadPhoto(photoSrc, filename) {
            try {
                // Если это base64 изображение
                if (photoSrc.startsWith('data:image/')) {
                    const link = document.createElement('a');
                    link.href = photoSrc;
                    link.download = filename || 'photo.jpg';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    return;
                }

                // Если это URL изображения
                const response = await fetch(photoSrc);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = filename || 'photo.jpg';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Ошибка скачивания фото:', error);
                alert('Ошибка при скачивании фотографии');
            }
        }

        // Функция для улучшения качества изображения
        function enhanceImage(imageSrc, options = {}) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function () {
                    // Увеличиваем разрешение
                    const scale = options.scale || 2;
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;

                    // Применяем сглаживание
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';

                    // Рисуем изображение с увеличенным размером
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                    // Применяем фильтры
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;

                    // Улучшение контраста и яркости
                    const brightness = options.brightness || 1.1;
                    const contrast = options.contrast || 1.2;
                    const saturation = options.saturation || 1.1;

                    for (let i = 0; i < data.length; i += 4) {
                        // Применяем яркость
                        data[i] *= brightness;     // Red
                        data[i + 1] *= brightness; // Green  
                        data[i + 2] *= brightness; // Blue

                        // Применяем контраст
                        data[i] = ((data[i] - 128) * contrast) + 128;
                        data[i + 1] = ((data[i + 1] - 128) * contrast) + 128;
                        data[i + 2] = ((data[i + 2] - 128) * contrast) + 128;

                        // Ограничиваем значения
                        data[i] = Math.max(0, Math.min(255, data[i]));
                        data[i + 1] = Math.max(0, Math.min(255, data[i + 1]));
                        data[i + 2] = Math.max(0, Math.min(255, data[i + 2]));
                    }

                    ctx.putImageData(imageData, 0, 0);

                    // Возвращаем улучшенное изображение как base64
                    const enhancedDataUrl = canvas.toDataURL('image/jpeg', 0.95);
                    resolve(enhancedDataUrl);
                };

                img.src = imageSrc;
            });
        }

        // Функция для показа модального окна с улучшением фото
        async function showPhotoEnhancer(photoSrc, filename) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';

            modal.innerHTML = `
                <div class="photo-modal-content">
                    <div class="modal-header">
                        <h3>🎨 Улучшение качества фотографии</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <div class="enhance-preview">
                        <div>
                            <div class="enhance-label">Оригинал</div>
                            <img src="${photoSrc}" class="original" alt="Оригинал">
                        </div>
                        <div>
                            <div class="enhance-label">Улучшенное</div>
                            <img id="enhancedPreview" src="${photoSrc}" class="enhanced" alt="Улучшенное">
                        </div>
                    </div>
                    
                    <div class="enhance-controls">
                        <div class="form-group">
                            <label class="form-label">Яркость: <span id="brightnessValue">1.1</span></label>
                            <input type="range" class="enhance-slider" id="brightnessSlider" 
                                   min="0.5" max="2" step="0.1" value="1.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Контраст: <span id="contrastValue">1.2</span></label>
                            <input type="range" class="enhance-slider" id="contrastSlider" 
                                   min="0.5" max="3" step="0.1" value="1.2">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Насыщенность: <span id="saturationValue">1.1</span></label>
                            <input type="range" class="enhance-slider" id="saturationSlider" 
                                   min="0.5" max="2" step="0.1" value="1.1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Масштаб: <span id="scaleValue">2</span>x</label>
                            <input type="range" class="enhance-slider" id="scaleSlider" 
                                   min="1" max="4" step="0.5" value="2">
                        </div>
                    </div>
                    
                    <div class="photo-modal-actions">
                        <button class="simple-button" onclick="applyEnhancement()">🎨 Применить</button>
                        <button class="simple-button" onclick="downloadEnhanced()">💾 Скачать улучшенное</button>
                        <button class="simple-button" onclick="resetEnhancement()">🔄 Сброс</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            let currentEnhanced = photoSrc;

            // Обработчики слайдеров
            const brightnessSlider = modal.querySelector('#brightnessSlider');
            const contrastSlider = modal.querySelector('#contrastSlider');
            const saturationSlider = modal.querySelector('#saturationSlider');
            const scaleSlider = modal.querySelector('#scaleSlider');

            const brightnessValue = modal.querySelector('#brightnessValue');
            const contrastValue = modal.querySelector('#contrastValue');
            const saturationValue = modal.querySelector('#saturationValue');
            const scaleValue = modal.querySelector('#scaleValue');

            const enhancedPreview = modal.querySelector('#enhancedPreview');

            function updateValues() {
                brightnessValue.textContent = brightnessSlider.value;
                contrastValue.textContent = contrastSlider.value;
                saturationValue.textContent = saturationSlider.value;
                scaleValue.textContent = scaleSlider.value;
            }

            brightnessSlider.oninput = updateValues;
            contrastSlider.oninput = updateValues;
            saturationSlider.oninput = updateValues;
            scaleSlider.oninput = updateValues;

            // Функции для модального окна
            window.applyEnhancement = async function () {
                const options = {
                    brightness: parseFloat(brightnessSlider.value),
                    contrast: parseFloat(contrastSlider.value),
                    saturation: parseFloat(saturationSlider.value),
                    scale: parseFloat(scaleSlider.value)
                };

                try {
                    enhancedPreview.style.opacity = '0.5';
                    currentEnhanced = await enhanceImage(photoSrc, options);
                    enhancedPreview.src = currentEnhanced;
                    enhancedPreview.style.opacity = '1';
                } catch (error) {
                    console.error('Ошибка улучшения:', error);
                    alert('Ошибка при улучшении изображения');
                    enhancedPreview.style.opacity = '1';
                }
            };

            window.downloadEnhanced = function () {
                downloadPhoto(currentEnhanced, `enhanced_${filename || 'photo.jpg'}`);
            };

            window.resetEnhancement = function () {
                brightnessSlider.value = '1.1';
                contrastSlider.value = '1.2';
                saturationSlider.value = '1.1';
                scaleSlider.value = '2';
                updateValues();
                enhancedPreview.src = photoSrc;
                currentEnhanced = photoSrc;
            };

            // Закрытие по клику вне модального окна
            modal.onclick = function (e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Функция для показа фото с действиями
        function showPhotoWithActions(photoSrc, filename, orderId, itemIndex) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';

            modal.innerHTML = `
                <div class="photo-modal-content">
                    <div class="modal-header">
                        <h3>📷 Просмотр фотографии</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    
                    <img src="${photoSrc}" alt="Фото товара" style="max-width: 100%; max-height: 60vh; object-fit: contain;">
                    
                    <div class="photo-modal-actions">
                        <button class="simple-button download" onclick="downloadPhoto('${photoSrc}', '${filename}')">
                            💾 Скачать оригинал
                        </button>
                        <button class="simple-button enhance" onclick="showPhotoEnhancer('${photoSrc}', '${filename}')">
                            🎨 Улучшить качество
                        </button>
                        <button class="simple-button" onclick="this.closest('.modal').remove()">
                            ❌ Закрыть
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Закрытие по клику вне модального окна
            modal.onclick = function (e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Экспортируем функции в глобальную область
        window.downloadPhoto = downloadPhoto;
        window.enhanceImage = enhanceImage;
        window.showPhotoEnhancer = showPhotoEnhancer;
        window.showPhotoWithActions = showPhotoWithActions;

        // Функция возврата назад
        function goBack() {
            console.log('🔙 Возврат назад');
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // Функции для обработки изображений
        function handleImageLoad(img) {
            if (img && img.classList) {
                img.classList.remove("loading");
            }
        }
        
        function handleImageError(img, fallbackText) {
            if (img) {
                img.style.display = "none";
                const fallback = img.nextElementSibling;
                if (fallback && fallback.classList.contains("image-fallback")) {
                    fallback.style.display = "flex";
                    fallback.textContent = fallbackText;
                }
            }
        }
    </script>

    <!-- SVG Stylized Back Button -->
    <button class="svg-back-button show" onclick="goBack()" aria-label="Назад">
        <img src="img/back_button.svg" alt="Назад" class="back-button-svg" 
             onerror="handleImageError(this, 'Назад')" 
             onload="handleImageLoad(this)">
    </button>
</body>

</html>